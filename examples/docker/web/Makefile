# Copyright (c) 2024 Stappler LLC <admin@stappler.dev>
#
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:
#
# The above copyright notice and this permission notice shall be included in
# all copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
# THE SOFTWARE.

STAPPLER_ROOT ?= ../../..

# force to rebuild if this makefile changed
LOCAL_MAKEFILE := $(lastword $(MAKEFILE_LIST))
LOCAL_DIR := $(realpath $(dir $(LOCAL_MAKEFILE)))

LOCAL_OUTDIR := stappler-build
LOCAL_LIBRARY := stappler_web_module

LOCAL_BUILD_STATIC := 0
LOCAL_BUILD_SHARED := 2

LOCAL_MODULES_PATHS = \
	$(STAPPLER_ROOT)/core/stappler-modules.mk \
	$(STAPPLER_ROOT)/extra/webserver/webserver-modules.mk 

LOCAL_MODULES ?= \
	stappler_webserver_httpd

LOCAL_ROOT = .

LOCAL_SRCS_DIRS := src
LOCAL_SRCS_OBJS :=

LOCAL_INCLUDES_DIRS :=
LOCAL_INCLUDES_OBJS :=

include $(STAPPLER_ROOT)/build/make/universal.mk

define HTTPD_DEFAULT_CONFIG
StartServers 2
DirectoryIndex index.html
LogLevel warn
LogFormat "%h %l %u %t \"%r\" %>s %b" common

SSLRandomSeed startup builtin
SSLRandomSeed connect builtin
SSLCipherSuite HIGH:MEDIUM:!aNULL:!MD5
SSLProtocol all -SSLv2 -SSLv3
SSLPassPhraseDialog  builtin
SSLSessionCache "shmcb:/home/apache/server/logs/ssl_scache(512000)"
SSLSessionCacheTimeout 300

LoadModule stappler_web_module $(abspath $(BUILD_INSTALL_SHARED_LIBRARY))
StapplerRootThreadsCount 1 2

ServerRoot "$(LOCAL_DIR)"
ErrorLog "logs/error_log"
CustomLog "logs/access_log" common
StapplerSourceRoot "$(LOCAL_OUTDIR)/host"
Include $(LOCAL_DIR)/conf/httpd.conf
endef

export HTTPD_DEFAULT_CONFIG
$(LOCAL_OUTDIR)/httpd.conf: Makefile
	@mkdir -p $(LOCAL_OUTDIR)
	@mkdir -p logs
	@echo '# Autogenerated by makefile\n' > $@
	@echo "$$HTTPD_DEFAULT_CONFIG" >> $@
	
install: $(LOCAL_OUTDIR)/httpd.conf
